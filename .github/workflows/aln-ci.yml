name: ALN CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint ALN Files
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Lint JavaScript
        run: npm run lint
        
      - name: Lint ALN files
        run: node aln/tools/aln_linter.js aln/

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run unit tests
        run: npm run test --workspace=aln/tests
        
      - name: Run core tests
        run: npm run test --workspace=aln/core

  build:
    name: Build Explorer
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build explorer
        run: npm run build --workspace=aln/explorer --if-present

  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Start node
        run: |
          cd aln/core
          node cli/aln_node_cli.js init
          node cli/aln_node_cli.js start &
          sleep 10
        
      - name: Test node API
        run: |
          curl http://localhost:3000/status || exit 1
          curl http://localhost:3000/health || exit 1
